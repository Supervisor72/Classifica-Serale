<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classifica Vendite PDV</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f8f9fa;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    td input {
      width: 100%;
      padding: 12px;
      font-size: 1.2em;
    }
    td.pdv {
      width: 30%;
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      color: white;
    }
    button.reset-btn {
      background-color: #dc3545; /* Rosso per il reset */
    }
    button.order-btn {
      background-color: #007bff; /* Blu per ordina */
    }
    button.telegram-btn {
      background-color: #0088cc; /* Blu scuro per Telegram */
    }
    button.whatsapp-btn {
      background-color: #25D366; /* Verde per WhatsApp */
    }
    #output {
      margin-top: 2rem;
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 5px;
      word-break: break-word; /* Assicura che le parole lunghe vadano a capo */
    }
  </style>
</head>
<body>
  <h1>Classifica Vendite Punti Vendita</h1>

  <form id="venditeForm">
    <table id="venditeTable">
      <thead>
        <tr>
          <th>Punto Vendita</th>
          <th>Valore (â‚¬)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
    </table>

    <div>
      <button type="button" id="resetBtn" class="reset-btn">ðŸ”„ Reset</button>
      <button type="button" id="orderBtn" class="order-btn">ðŸ“Š Ordina</button>
      <button type="button" id="telegramBtn" class="telegram-btn">ðŸ“¨ Messaggio Telegram</button>
      <button type="button" id="whatsappBtn" class="whatsapp-btn">ðŸ“± Messaggio WhatsApp</button>
    </div>
  </form>

  <div id="output"></div>

  <script>
    const puntiVendita = [
      "AQUILA", "AVEZZANO", "BOLOGNA", "CARPI", "CDC", "CESENA", "CHIOGGIA", "CIVITANOVA", "CONEGLIANO", "FABRIANO",
      "FAENZA", "FANO", "FOLIGNO", "FORLI", "IMOLA", "LANCIANO", "MACERATA", "MARANELLO", "MONSANO", "OSIMO",
      "PADOVA", "PESCARA", "PESARO", "REGGIO", "RIETI", "RIMINI", "RSM", "SALA", "SBT", "TERMOLI",
      "TERAMO", "VASTO", "VICENZA", "VITERBO"
    ].sort();

    const tbody = document.getElementById('tableBody');
    const venditeForm = document.getElementById('venditeForm');
    const outputDiv = document.getElementById('output');

    // Funzione per inizializzare le righe del form
    function initializeTable() {
      puntiVendita.forEach(pdv => {
        const row = document.createElement('tr');
        // Usa un attributo `data-pdv` per identificare il punto vendita, utile per il salvataggio/caricamento
        row.innerHTML = `
          <td class="pdv">${pdv}</td>
          <td><input type="number" data-pdv="${pdv}" placeholder="Inserisci venduto"></td>
        `;
        tbody.appendChild(row);
      });
    }

    // --- Funzioni per il salvataggio e caricamento dati (LocalStorage) ---

    function saveData() {
      const dataToSave = {};
      tbody.querySelectorAll('input[type="number"]').forEach(input => {
        const pdvName = input.dataset.pdv;
        dataToSave[pdvName] = input.value;
      });
      localStorage.setItem('venditeData', JSON.stringify(dataToSave));
    }

    function loadData() {
      const storedData = localStorage.getItem('venditeData');
      if (storedData) {
        const data = JSON.parse(storedData);
        tbody.querySelectorAll('input[type="number"]').forEach(input => {
          const pdvName = input.dataset.pdv;
          if (data[pdvName]) {
            input.value = data[pdvName];
          }
        });
      }
    }

    // --- Funzioni esistenti modificate per il reset e l'ordine ---

    function resetTable() {
      tbody.querySelectorAll('input').forEach(input => input.value = '');
      outputDiv.textContent = '';
      localStorage.removeItem('venditeData'); // Rimuove i dati salvati
      alert('Tutti i campi sono stati resettati e i dati cancellati!');
    }

    function ordinaVendite() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const valA = parseFloat(a.cells[1].querySelector('input').value) || 0;
        const valB = parseFloat(b.cells[1].querySelector('input').value) || 0;
        return valB - valA;
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    // --- Funzioni per la generazione dei messaggi ---

    function getFormattedMessage() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const dati = rows.map(row => {
        const pdv = row.cells[0].textContent.trim();
        const val = parseFloat(row.cells[1].querySelector('input').value) || 0;
        return { pdv, val };
      }).sort((a, b) => b.val - a.val);

      let messaggio = "ðŸ† *CLASSIFICA FINALE* ðŸ†\n\n";
      dati.forEach((item, i) => {
        const formattedValue = item.val.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Formatta senza decimali
        messaggio += `${i + 1}. ${item.pdv.padEnd(12)}: â‚¬ ${formattedValue}\n`;
      });
      return messaggio;
    }

    function generaMessaggio() {
      const messaggio = getFormattedMessage();
      outputDiv.textContent = messaggio; // Visualizza il messaggio nell'output div

      // Codifica il messaggio per il link Telegram
      // Telegram usa URL Scheme tg://msg_url?url= e richiede una URL valida, il testo va nel parametro 'url'.
      // Per testo piÃ¹ lungo Ã¨ preferibile usare l'API di Telegram, ma per messaggi brevi funziona.
      // Un approccio piÃ¹ robusto per Telegram web/desktop sarebbe https://t.me/share/url?url=...&text=...
      // Ma per l'apertura diretta dell'app, `tg://msg_url?text=` Ã¨ piÃ¹ comune per solo testo.
      // Se `tg://msg_url?url=` non funziona come previsto su tutti i dispositivi/client,
      // un'alternativa piÃ¹ affidabile per *solo testo* che apre l'app su mobile Ã¨ `tg://msg?text=`
      // Tuttavia, per il web e app desktop, 't.me/share/url' Ã¨ spesso preferito.
      // Consideriamo il caso piÃ¹ comune per l'apertura diretta con il tuo setup:
      const encodedMessage = encodeURIComponent(messaggio);
      const telegramLink = `tg://msg?text=${encodedMessage}`;
      
      window.location.href = telegramLink;
    }

    function generaMessaggioWhatsapp() {
      const messaggio = getFormattedMessage();
      outputDiv.textContent = messaggio; // Visualizza il messaggio nell'output div

      // Codifica il messaggio per il link WhatsApp
      const encodedMessage = encodeURIComponent(messaggio);
      // WhatsApp usa `https://wa.me/?text=` per messaggi semplici
      const whatsappLink = `https://wa.me/?text=${encodedMessage}`;

      window.location.href = whatsappLink;
    }

    // --- Inizializzazione e Event Listeners ---

    document.addEventListener('DOMContentLoaded', () => {
      initializeTable(); // Inizializza la tabella con tutti i punti vendita
      loadData();        // Carica i dati salvati quando la pagina Ã¨ pronta

      // Aggiungi un listener per il salvataggio automatico ad ogni input
      tbody.addEventListener('input', saveData);

      // Associa le funzioni ai bottoni usando gli ID
      document.getElementById('resetBtn').addEventListener('click', resetTable);
      document.getElementById('orderBtn').addEventListener('click', ordinaVendite);
      document.getElementById('telegramBtn').addEventListener('click', generaMessaggio);
      document.getElementById('whatsappBtn').addEventListener('click', generaMessaggioWhatsapp);
    });
  </script>
</body>
</html>
